---
.create_release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:v0.6.0
  script:
    - echo "Creating release"
  release:
    description: ${CI_MERGE_REQUEST_TITLE:-$CI_COMMIT_TITLE}
    tag_name: $(cat VERSION)

.tag_image:
  stage: release
  tags:
    - docker-build
  variables:
    GIT_STRATEGY: none
    DOCKER_IMAGE: $CI_REGISTRY_IMAGE
  before_script:
    - !reference [.docker_login, script]
    - !reference [.set_app_version, script]
  script:
    - docker pull "$DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA"
    - docker tag "$DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA" "$DOCKER_IMAGE:latest"
    - docker push "$DOCKER_IMAGE:latest"
    - docker tag "$DOCKER_IMAGE:$CI_COMMIT_SHORT_SHA" "$DOCKER_IMAGE:$APP_VERSION"
    - docker push "$DOCKER_IMAGE:$APP_VERSION"
